#!/bin/sh

set -xue

case "$#" in
    1) MACHINE=$1 ;;
    0)
	echo "Warning: assuming on jet machine" 1>&2
        MACHINE=jet ;;
    *) 
	echo "Usage: $0 machine" 1>&2
	echo "Install compile WW3 on this machine" 1>&2
	echo "Example: $0 jet" 1>&2
	exit 1
	;;
esac

echo ${MACHINE}

# check NETCDF environment variables
case "$MACHINE" in
    jet)
	if [[ ! -z "$NETCDF" ]] ; then
	    export WWATCH3_NETCDF=NC4
	    export NETCDF_CONFIG="${NETCDF}/bin/nc-config"
	elif [[ ! -z "$NETCDF4" ]] ; then
	    export WWATCH3_NETCDF=NC4
	    export NETCDF_CONFIG="${NETCDF4}/bin/nc-config"
	else
	    echo "WARNING: WWATCH3_NETCDF not defined"
	fi
	;;
    wcosscray)
	export WWATCH3_NETCDF=NC4
	# Note:
	# This nc-config currently is not the correct one.  The
	# comp/link options for NETCDF is actually manually specified
	# by comp/link.Intel_wcosscray.
	NC_CONFIG=`which nc-config` 
	export NETCDF_CONFIG="${NC_CONFIG}"
	;;
    wcoss)
	export WWATCH3_NETCDF=NC4
	export NETCDF_CONFIG="${NETCDF}/bin/nc-config"
	;;
    theia)
	export WWATCH3_NETCDF=NC4
	export NETCDF_CONFIG="${NETCDF}/bin/nc-config"
	;;
    *)
	echo "WARNING: Unkown machine" 1>&2
	echo "WARNING: WWATCH3_NETCDF not defined" 1>&2
	exit 1
esac

echo "WWATCH3_NETCDF=${WWATCH3_NETCDF}" 1>&2
echo "NETCDF_CONFIG=${NETCDF_CONFIG}" 1>&2

cd build/

# Load the library specifications generated by the "configure" script.
.  ./grib2libs.env

cat<<EOF
G2_LIB4    = $G2_LIB4
W3NCO_LIB4 = $W3NCO_LIB4
BACIO_LIB4 = $BACIO_LIB4
JASPER_LIB = $JASPER_LIB
PNG_LIB    = $PNG_LIB
Z_LIB      = $Z_LIB
EOF
export G2_LIB4 W3NCO_LIB4 BACIO_LIB4 JASPER_LIB PNG_LIB Z_LIB

if [[ ! -d bin ]] ; then
   # Link install script and run install 
   ln -sf svn/model/bin/install_ww3_svn .
   
   # Install WW3 into the build directory
   ./install_ww3_svn << EOF
y
L
y
n
y
n
EOF
fi
   
cd bin

# choose correct comp and link files
# can be done in the configure step
cp comp.Intel_$MACHINE comp
cp link.Intel_$MACHINE link

# use proper switch file
cp switch_CPL_HWRF switch
#cp switch_NCEP_st4 switch
#cp switch_NCEP_st2 switch

# compile WW3 
./make_CPL

echo 'Compile WW3 done'

