
\section{~Installing the wave model} \label{chapt:impl}
\newcounters
\vssub
\subsection{~Introduction}
\vssub

\ws\ is written in ANSI standard \fortran-90, with in essence no
machine-dependent elements, so that \ws\ can be installed without
modifications on most platforms. \ws\ utilizes its own preprocessor to process
include files (presently only used for adding \ncep-specific documentation),
to select model options at the compile level, and to switch test output on or
off. This approach proved to be efficient during the development of \ws, but
it complicates the installation of \ws. To minimize complications, a set of
\unix/Linux scripts is provided to automate the installation in general and
the use of the preprocessor in particular. This option is not supported for
other operation systems like MS or Mac products. If the code is to be compiled
on one of the latter platforms, it is suggested to extract a working code in a
\unix/Linux environment using the utility {\code w3\_source} (see below), and
than to port this clean code to the platform of choice.

\begin{center}
\rule[1mm]{55mm}{1.0mm} WARNING \rule[1mm]{55mm}{1.0mm} \\ 
\vspace{\baselineskip}
\parbox{120mm}{If version \WWver\ is implemented as an upgrade to previous
versions of \ws, please note that this version may not be compatible with
previous model versions. It is therefore prudent {\it NOT} to install the new
version of \ws\ on top of the old version. See Appendix~\ref{app:more} for
suggestions on managing multiple model version.} \\ \vspace{\baselineskip}
\rule[1mm]{55mm}{1.0mm} WARNING \rule[1mm]{55mm}{1.0mm}
\end{center}

%\pb

\vssub
\subsection{~Installing files}\label{sec:install}
\vssub

In its packaged version, \ws\ is contained in several files:

\begin{list}{???}{\parsep 0mm \itemsep 0mm 
                  \leftmargin 40mm \rightmargin 5mm
                  \labelwidth 30mm \labelsep 5mm}
\item[{\file install\_wwatch3} \hfill]
The \ws\ install program. 
\item[{\file wwatch3.aux.tar} \hfill] Archive file containing programs and
scripts controlling the compiling and linking of and code management of \ws.
\item[{\file wwatch3.ftn.tar} \hfill]
Archive file containing source code.
\item[{\file wwatch3.inp.tar} \hfill]
Archive file containing example input files. 
\item[{\file wwatch3.tst.tar} \hfill]
Archive file containing test cases with results. 
\end{list}

\noindent
As the first step of installing \ws, these files have to be copied to a work
directory on the machine on which \ws\ will be installed. Because this
directory will be the `home' directory of \ws, it is suggested that a new
directory is created (see also warning in previous section). Furthermore
{\file install\_wwatch3} has to be made executable by typing \command{chmod
700 install\_wwatch3} after which the installation of the files is started by
typing \command{install\_wwatch3}

\begin{center}
\rule[1mm]{55mm}{1.0mm} WARNING \rule[1mm]{55mm}{1.0mm} \\ \vspace{\baselineskip}
\parbox{120mm}{The install program will ask for a compiler to compile some
auxiliary \fortran\ codes used in putting \ws\ together. Unlike the actual
\ws\ source code, these programs are still written in \fortran-77. It is
therefore sufficient to point toward the generic \fortran-77 compiler on the
system. This choice of mixed codes was made to assure that if \ws\ is put on a
\unix/Linux box only to put the code together, it will not be necessary to buy
a \fortran-90 compiler.} \\ \vspace{\baselineskip} \rule[1mm]{55mm}{1.0mm}
WARNING \rule[1mm]{55mm}{1.0mm}
\end{center}

When {\file install\_wwatch3} is executed for the first time, it will ask the
user to identify the directory in which \ws\ will be installed. This has to be
the directory in which the above five files reside. The program will then
print a message that it cannot find the setup file, and ask some
questions. The default answer or options are shown in square brackets. After
the user has verified that the setup parameters are satisfactorily, the
install program will, by default, create the (hidden) setup file
{\file .wwatch3.env} in the user's home directory.
An alternate setup file may be specified prior to running {\file install\_wwatch3}
by setting {\file WWATCH3\_ENV} in the user environment.
The setup can be modified by rerunning the install
program, or by manually editing the setup file. The
`home' directory of \ws\ can only be changed by editing or removing {\file
.wwatch3.env} or by changing {\file WWATCH3\_ENV} in the user environment.

After the setup file is processed, the install program asks if the user wants
to continue with the installation. If the user chooses to continue, the
program will look for the four archive files. If a file is found, the program
asks if the contents of the file should be installed. If no files are found,
the archive files do not reside in the home directory, or the home directory
is erroneously defined. To avoid that the install program generates unwanted
files and directories in such a case, abort the install program (type Ctrl C),
and check the location of the archive files, and the `home' directory of \ws\
(see previous paragraph).

After files to be unpacked have been identified, the program will ask if old
files should be overwritten automatically. If the user chooses `n', the
program will ask permission to overwrite each file that already exists. Files
that contain user specific information, such as compile and link options, will
never be replaced by the install program.

As the first step of the actual installation, the install program checks if the following directories exist in the `home' directory of \ws.
 
\begin{dlist}
\dit{arc }{Archive directory.}
\dit{aux }{Raw auxiliary programs (source codes etc.).}
\dit{bin }{Executables and shell scripts for compiling and linking.}
\dit{exe }{\ws\ executables.}
\dit{ftn }{Source code and makefile.}
\dit{inp }{Input files.}
\dit{mod }{Module files.}
\dit{obj }{Object files.}
\dit{test}{Scripts with test cases.}
\dit{work}{Auxiliary work directory.}
\end{dlist}

\noindent
All these directories are generated by the install program {\file
install\_wwatch3}, except for the archive directory, which is generated by
{\file arc\_wwatch3} (see below).

If installation of the auxiliary programs is requested (file {\file
wwatch3.aux.tar}), the install program will first process source codes of
auxiliary programs, using the compiler as defined by the user in the setup
file. Note that these codes are still in fixed format \fortran-77.

\begin{flist}
\fit{w3adc.f }{\ws\ {\fortran} preprocessor.}
\fit{w3prnt.f}{Print files (source codes) including page and line numbers.}
\fit{w3list.f}{Generate a generic source code listing.}
\fit{w3split.f}{Generate spectral bulletin identifying individual wave fields within a spectrum from the spectral output of the point output post-processor (see \para\ref{sec:post_p}).}
\end{flist}

\noindent
The above source codes are stored in the directory {\dir aux} and the
executables are stored in the directory {\dir bin}. A more detailed
description of these programs (including instructions on running the
executables) can be found in the documentation included in the above source
code files. After the compilation of these programs, several \unix\ shell
scripts and auxiliary files are installed in the {\dir bin} directory.

\begin{flist}
\fit{ad3              }{Script to run the preprocessor {\file w3adc}
                        and the compile script {\file comp} for a given
                        source code file.}
\fit{ad3\_test        }{Test version of {\file ad3}, showing modifications
                        to original source file. This script does not
                        compile code.}
\fit{all\_switches    }{Generates a list of all {\code w3adc} switches 
                        present in the source code files.}
\fit{arc\_wwatch3     }{Program to archive versions of \ws\ in the 
                        directory {\dir arc}.}
\fit{comp.gen         }{Generic compiler script. The actual compiler
                        script {\file comp} will be copied from this
                        script if it does not exists.}
\fit{comp.{\it xxx}   }{The compiler script {\file comp} for a specific
                        hardware-compiler combination.}
\fit{find\_switch     }{Script to find \ws\ source code files containing 
                       compiler switches (or arbitrary strings).}
\fit{link.gen         }{Generic linker script. Actual script is {\file
                        link}.}
\fit{link.{\it xxx}   }{The link script {\file comp} for a specific
                        hardware-compiler combination.}
\fit{list             }{Script to print source code listing using 
                        {\file w3prnt}.}
\fit{ln3              }{Script to make symbolic link of source code file
                        to work directory.}
\fit{make\_makefile.sh}{Script to generate the of the makefile based
                        on selections in the file {\file switch})}. 
\fit{switch.gen       }{Generic file with preprocessor switches
                        (\para\ref{sec:switches}).}
\fit{w3\_clean        }{Script to clean up work and scratch directories
                        by removing files generated during compilation or
                        test runs.}
\fit{w3\_make         }{Script to compile and link components of \ws\
                        using a makefile.}
\fit{w3\_new          }{Script to touch correct source code files
                        to account for changes in compiler switches in
                        combination with the makefile.} 
\fit{w3\_source       }{Script to generate a true \fortran\ source
                        code for any of he \ws\ program elements.} 
\fit{w3\_setup        }{Script for creating/editing the \ws\ environment setup file.
                        The default setup file is {\file \$\{HOME\}/.wwatch3.env}.
                        An alternate setup file can be specified with the
                        {\file WWATCH3\_ENV environment variable.}} 
\end{flist}

\noindent
The use of these scripts is explained in \para\ref{sec:comp}.
Note that the above scripts aquire setup information from the \ws\ environment setup
file defined by {\file WWATCH3\_ENV}, or, if that is not defined, from the default
setup file {\file \$\{HOME\}/.wwatch3.env}.

\noindent
After installation in the {\dir bin} directory, several GrADS scripts are installed
in the {\dir aux} directory.

\begin{flist}
\fit{cbarn.gs         }{Semi-standard GrADS script for displaying
                        color bars.}
\fit{colorset.gs      }{Script to define colors used in shading.}
\fit{map2\_{\it n}.gs }{Script used in propagation test {\file ww3\_tp2.}{\it{n}},
                       can be used as template for specialized map plots.}
\fit{map\_s3.gs}      {Idem for moving grid hurricane test {\file ww3\_ts3}.}
\fit{source.gs}       {Script for composite plot of spectra and source
                       terms (2-D polar or Cartesian plots in color or in
                       black and white).}
\fit{1source.gs}      {Script to plot single source term.}
\fit{spec.gs}         {Script to plot spectra.}
\fit{profile.gs}      {Script to display profiling data generated by {\file
                       ww3\_multi}.} 
\end{flist}

\noindent
As the final step of processing {\file wwatch3.aux.tar}, some links between
directories are established.

If the installation of the source code is requested (file {\file
wwatch3.ftn.tar}), the install program will copy source code and include files
to the directory {\dir ftn}. All the files considered are discussed in detail
in chapter~\ref{chapt:sys}.

If the installation of the input files is requested (file {\file
wwatch3.inp.tar}), the install program will copy the example input files as
presented in the previous chapter to the directory {\dir inp}. Links are make
to the work directory {\dir work}. No other action is taken.

If the installation of the test cases is requested (file {\file
wwatch3.tst.tar}), the install program will copy the test cases to the
directory {\dir test} (see~\para\ref{sec:tests}). No other action is taken.

Finally, the install program lists manual modifications required by or
suggested to the user. These messages are printed only if the compile and link
system are installed (file {\file wwatch3.aux.tar}).


% -------------------------------------------------------------
\vssub
\subsection{~Compiling and linking} \label{sec:comp}
\vssub

Compilation of \ws\ is performed using the script {\file w3\_make} in the
{\dir bin} directory\footnote{~Note that before running {\file w3\_make}
several user interventions are needed as described in the remainder of this
section.}.  If this script is used without parameters, all basic programs of
\ws\ are compiled. Optionally, names of programs to be compiled can be given
as part of the compile command. For instance \command{w3\_make ww3\_grid
ww3\_strt} will compile the grid preprocessor and the initial conditions
program only. {\file w3\_make} uses several of the scripts described in the
previous section. A graphical representation is given in
Fig.~\ref{fig:make}. \input{fig_make} If necessary, the script {\file
w3\_make} uses the scripts {\file make\_makefile.sh} to generate a
makefile. {\file make\_makefile.sh} generates a list of modules to be linked,
based on the program switches in the file {\file switch}
(see~\para\ref{sec:switches}), and checks all needed sources for module
dependencies. If switches have been changed since the last call to {\file
w3\_make}, {\file w3\_new} is used to `touch' relevant source code or to
delete relevant object files. After the makefile has been completed, the
standard \unix\ make utility is used to compile and link the programs. Instead
of directly using the \fortran\ compiler, the makefile invokes the
preprocessor and compile scripts {\file ad3} and {\file comp}, and the link
script {\file link}. The script {\file ad3} uses the extension of the file
name to determine the necessary action. Files with extension {\file .ftn} are
processed by {\code w3adc}, files with extension {\file .f} or {\file .f90}
are send to the script {\code comp} directly.  Although a user could try out
several of these scripts interactively, he or she generally needs to run
{w3\_make} only.

\vspace{\baselineskip} \noindent 
Before a first attempt is made at compiling, user intervention is required in
three scripts/files. For convenience of debugging and development, links to
these three files are made in the work directory {\dir work}. The files in the
work directory are

\begin{flist}
\fit{comp}  {Compiler script. This script requires the correct definition
             of the compiler and its options. Linked to {\file ../bin/comp}}
\fit{link}  {Linker script. This script requires the correct definition
             of the linker and its options. Linked to {\file ../bin/link}}
\fit{switch}{File containing a list of switches as recognized by the
             preprocessor {\file w3adc}. Linked to {\file ../bin/switch}}. The
             file provided with \ws\ should result in a hardware independent
             code.
\end{flist}

\vspace{\baselineskip}

\begin{center}
\rule[1mm]{55mm}{1.0mm} WARNING \rule[1mm]{55mm}{1.0mm} \\ 
\vspace{\baselineskip}
\parbox{120mm}{The auxiliary scripts {\file w3\_make} etc. use the {\file
  switch}, {\file comp} and {\file link} files from the {\file ./bin}
  directory under the \ws\ home directory, {\it NOT} from the local
  directory.} \\ \vspace{\baselineskip} \rule[1mm]{55mm}{1.0mm} WARNING
  \rule[1mm]{55mm}{1.0mm}
\end{center}

\noindent
After the appropriate changes have been made, or the appropriate example
scripts have been copied in, (parts of) \ws\ can be compiled and linked. When
the program is compiled for the first time, it is suggested to compile program
parts one-by-one to avoid lengthy errors messages, and to set up error
capturing in {\file comp}. A good place to start is compilation of the simple
test code {\F ctest}. First go to the directory {\dir work} and make a link to
the source code of this routine by typing \command{ln3 ctest} This link is
made to facilitate later inclusion of errors to test or set-up error capturing
in the script {\file comp}. The inner workings of the preprocessor {\file
w3adc} can be seen by typing the command \command{ad3\_test ctest} which will
show how the actual source code is constructed from {\file ctest.ftn}, include
files and program switches. Next, the compilation of this subroutine can be
tested by typing \command{ad3 ctest 1} which invokes both the preprocessor
{\file w3adc} and the compile script {\file comp}. The 1 at the end of this
line activates test output. If it is omitted, this command should result in a
single line of output, identifying that the routine is being processed. If
{\file ad3} works as expected, an object file {\file obj/ctest.o} is
generated. If requested during the initial set up, a source code and listing
file ({\file ctest.f} and {\file ctest.l}) can be found in the scratch
directory. The listing file is also retained if compilation errors are
detected by {\file comp}. At this time, it is prudent to test error capturing
in the script {\file comp} by adding errors and warnings to {\file ctest.ftn}
in the work directory. The error capturing is discussed in some detail in the
documentation of {\file comp}. After {\file comp} has been tested, and the
errors in {\file ctest.ftn} have been removed, the link to the work directory
and the file {\file obj/ctest.o} can be deleted.

After a single routine has been compiled successfully, the next step is to try
to compile and link an entire program. The grid preprocessor can be compiled
by typing \command{w3\_make ww3\_grid} If the compilation appears successful,
and if the input files have been installed (see above), the grid preprocessor
can be tested by typing \command{ww3\_grid} in the work directory. If the
input files have been installed, a link to the input file {\file
ww3\_grid.inp} will be present in the work directory, and the grid
preprocessor will run and send its output to the screen. Output files of the
grid preprocessor will appear in the work directory. When a program is
compiled for the first time, the operating system might not be able to find
the executable. If this occurs, try to type \command{rehash} or open a new
shell to work from. In this way all separate programs can be compiled and
tested. To clean up all temporarily files (such as listings) and data files of
the test runs, type \command{w3\_clean} Note that {\file w3\_make} only checks
the switch file for changes. If the user changes the compile options in the
compile and link scripts {\file comp} and {\file link}, it is advised to force
the recompilation of the entire program. This can be achieved by typing
\command{w3\_new all {\rm or} w3\_new} before invoking {\file w3\_make}. This
might also be useful if the compilation is unsuccessful for no apparent
reason.

\vspace{\baselineskip} 
\noindent
Compile of the \ws\ NetCDF enabled programs requires the
environment variable {\file WWATCH3\_NETCDF} be set to either
NC3 (compile with NetCDF version 3.x) or
NC4 (compile with NetCDF version 4.x).
If {\file WWATCH3\_NETCDF} = NC3, then the following environment variables
are required.
\begin{flist}
\fit {NETCDF\_LIBDIR} {Path to where the NetCDF-3 libraries are installed.}
\fit {NETCDF\_INCDIR} {Path to where the NetCDF-3 include files are installed.}
\end{flist}
If {\file WWATCH3\_NETCDF} = NC4, then the following environment variables
are required.
\begin{flist}
\fit {NETCDF\_CONFIG} {Path to the NetCDF-4 nc-config utility program.}
\end{flist}
The nc-config utility program (part of the NetCDF-4 install) is used to
determine the appropriate compile and link flags for the
{\file WWATCH3\_NETCDF} = NC4 compile.
The NetCDF-4 compile requires NetCDF version 4.1.1 or higher.
Use "{\code nc-config --version}" to check the version of the installed
NetCDF.
Compiling with the {\sc NC4} switch requires {\file WWATCH3\_NETCDF} = NC4
and the NetCDF-4 installation compiled with the NetCDF-4 API enabled.
Use "{\code nc-config --has-nc4}" to check if the installed NetCDF has
the NetCDF-4 API enabled.

\vspace{\baselineskip} 
\noindent 
Two additional remarks need to be made regarding parallel versions of the
model (OpenMP and \mpi\ versions). First, complications may occur when
preparing executables for running in an \mpi\ environment. Such complications
are discussed in Appendix~\ref{app:mpi}. Secondly, the \omp\ code should be
compiled using directives only, i.e., do not use compiler options that
automatically thread the code.


\pb
% -------------------------------------------------------------
\vssub
\subsection{~Selecting model options} \label{sec:switches}
\vssub

The file {\file switch} in the {\file bin} directory contains a set of strings
identifying model options to be selected. Many options are available. Of
several groups of options it is mandatory to select exactly one. These
mandatory switches are described in \para\ref{sub:man_switch}. Other switches
are optional, and are described in \para\ref{sub:opt_switch}. Default model
setting are identified in \para\ref{sub:opt_default}. The order in which the
switches appear in {\file switch} is arbitrary. How these switches are
included in the source code files is described in \para\ref{sec:w3adc}.


% -------------------------------------------------------------
\vsssub
\subsubsection{~Mandatory switches} \label{sub:man_switch}
\vsssub

Of each of the below groups of switches exactly one has to be selected. The
first group of switches controls the selection of machine-dependent code. With
the introduction of \fortran-90 this set of switches should have become
obsolete. Problems with some compilers have prompted the retention of the
second switch.
\begin{slist}
\sit{f90} {\fortran-90 style date and time capturing and program
           abort.}
\sit{dum} {Dummy to be used if \ws\ is to be installed on
           previously untried hardware.}
\end{slist}

\noindent
Hardware model (first group) and message passing protocol (second group). Note
that these two groups share a switch. This implies that the {\sc mpi} switch
can only be used in combination with the {\sc dist} switch.
\begin{slist}
\sit{shrd}{Shared memory model.}
\sit{dist}{Distributed memory model}.
\end{slist}

\begin{slist}
\sit{shrd}{Shared memory model, no message passing.}
\sit{mpi} {Message Passing Interface (MPI).}
\end{slist}

\noindent
Word length used to determine record length in direct access files
\begin{slist}
\sit{lrb4}{4 byte words.}
\sit{lrb8}{8 byte words.}
\end{slist}

\noindent
Compilation as a subroutine (called by a coupled model system) or a stand-alone program
\begin{slist}
\sit{nopa}{Compilation as a stand-alone program}
\sit{palm}{Compilation as a subroutine }
\end{slist}
 
\pb \noindent
Selection of grid type (NOTE: this is obsolete in v4.00; {\sc xyg} and {\sc llg} are now specified in {\file ww3\_grid.inp}):
\begin{slist}
\sit{llg} {Spherical grid.}
\sit{xyg} {Cartesian grid.}
\end{slist}

\noindent
Selection of propagation schemes:
\begin{slist}
\sit{pr0} {No propagation scheme used.}
\sit{pr1} {First order propagation scheme.}
\sit{pr2} {\uq\ propagation scheme with \cite{art:BH87}
           dispersion correction.}
\sit{pr3} {\uq\ propagation scheme with \cite{tol:OMOD02b}
          averaging technique.}
%\sit{pr4} {\uq\ propagation scheme with \cite{tol:OMOD02b}
%           divergence technique.}
\sit{prx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection of flux computation:
\begin{slist}
\sit{flx0} {No routine used; flux computation included in source terms,}
\sit{flx1} {Friction velocity according to Eq.~(\ref{eq:Wu}).}
\sit{flx2} {Friction velocity form Tolman and Chalikov input.}
\sit{flx3} {Idem, with cap of Eq.~(\ref{eq:Cd_cap_1}) or (\ref{eq:Cd_cap_2}).}
\sit{flxx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection of linear input:
\begin{slist}
\sit{ln0} {No linear input.}
\sit{seed}{Spectral seeding of Eq.~(\ref{eq:seed}).}
\sit{ln1} {Cavaleri and Malanotte-Rizzoli with filter.}
\sit{lnx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection of input and dissipation:
\begin{slist}
\sit{st0} {No input and dissipation used.}
\sit{st1} {\wam\-3 source term package.}
\sit{st2} {\cite{tol:JPO96} source term package. See also
          the optional {\sc stab2} switch.}
\sit{stab2}{Enable stability correction (\ref{eq:scor})
           - (\ref{eq:stab}) for \cite{tol:JPO96} source
           term package.}
\sit{st3} {\wam\-4 and variants source term package.}
\sit{stab3}{Enable stability correction from \cite{rep:AB02}
            for \wam\-4 source term package.}
\sit{st4} {\cite{art:Aea10} source term package.}
\sit{stx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection of nonlinear interactions:
\begin{slist}
\sit{nl0} {No nonlinear interactions used.}
\sit{nl1} {Discrete interaction approximation (\dia).}
\sit{nl2} {Exact interaction approximation (\xnl).}
\sit{nlx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection of bottom friction:
\begin{slist}
\sit{bt0} {No bottom friction used.}
\sit{bt1} {\js\ bottom friction formulation.}
\sit{btx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection depth-induced breaking of :
\begin{slist}
\sit{db0} {No depth-induced breaking used.}
\sit{db1} {Battjes-Janssen.}
\sit{dbx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection of triad interactions:
\begin{slist}
\sit{tr0} {No triad interactions used.}
\sit{trx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection of bottom scattering:
\begin{slist}
\sit{bs0} {No bottom scattering used.}
\sit{bsx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection of supplemental source term:
\begin{slist}
\sit{xx0} {No supplemental source term used.}
\sit{xxx} {Experimental (user supplied).}
\end{slist}

\noindent
Selection of method of wind interpolation (time):
\begin{slist}
\sit{wnt0}{No interpolation.}
\sit{wnt1}{Linear interpolation.}
\sit{wnt2}{Approximately quadratic interpolation.}
\end{slist}

\pb \noindent
Selection of method of wind interpolation (space):
\begin{slist}
\sit{wnx0}{Vector interpolation.}
\sit{wnx1}{Approximately linear speed interpolation.}
\sit{wnx2}{Approximately quadratic speed interpolation.}
\end{slist}

\noindent
Selection of method of current interpolation (time):
\begin{slist}
\sit{crt1}{Linear interpolation.}
\sit{crt2}{Approximately quadratic interpolation.}
\end{slist}

\noindent
Selection of method of current interpolation (space):
\begin{slist}
\sit{crx0}{Vector interpolation}
\sit{crx1}{Approximate linear speed interpolation.}
\sit{crx2}{Approximate quadratic speed interpolation.}
\end{slist}

\noindent
Switch for user supplied GRIB package.
\begin{slist}
\sit{nogrb}{No package included.}
\sit{ncep1}{\ncep\ GRIB1 package for IBM SP.}
\sit{ncep2}{\ncep\ GRIB2 package for IBM SP.}
\end{slist}


% -------------------------------------------------------------
\vsssub
\subsubsection{~Optional switches} \label{sub:opt_switch}
\vsssub

All switches below activate model behavior if selected, but do not require
particular combinations. The following switches control optional output for
\ws\ programs.

\begin{slist}
\sit{o0}  {Output of namelists in grid preprocessor.}
\sit{o1}  {Output of boundary points in grid preprocessor.}
\sit{o2}  {Output of the grid point status map in grid preprocessor.} 
\sita{o2} {Generation of land-sea mask file {\file mask.ww3} in grid
           preprocessor.}
\sitb{o2} {Output of obstruction map in grid preprocessor.}
\sitc{o2} {Print status map in format as read by {\file ww3\_grid}.}
\sit{o3}  {Additional output in loop over fields in field preprocessor.}
\sit{o4}  {Print plot of normalized one-dimensional energy
           spectrum in initial conditions program.}
\sit{o5}  {Id. two-dimensional energy spectrum.}
\sit{o6}  {Id. spatial distribution of wave heights (not adapted for 
           distributed memory).}
\sit{o7}  {Echo input data for homogeneous fields in generic shell.}
\sita{o7} {Diagnostic output for output points.}
\sitb{o7} {Idem in {\file ww3\_multi}.}
\sit{o8}  {Filter field output for extremely small wave heights
           in wave model (useful for some propagation tests).}
\sit{o9}  {Assign a negative wave height to negative energy in wave model.
           Used in testing phase of new propagation schemes.}
\sit{o10} {Identify main elements of multi-grid model extensions in
           standard output.}
\sit{o11} {Additional log output on management algorithm in {\file log.mww3}.}
\sit{o12} {Identify removed boundary points in overlapping grids (center).}
\sit{o13} {Identify removed boundary points in overlapping grids (edge).}
\sit{o14} {Generate log file with buoy data {\file buoy\_log.ww3} for output
           type {\code ITYPE = 0} in {\file ww3\_outp}.}
\sit{o15} {Generate log file with time stamps of input data file {\file
           times.XXX} in {\file ww3\_prep}.}
\end{slist}

\noindent
The following switches enable parallelization of the model using \omp\
directives, also known as `threading'. Note that in the present version of the
model, threading and parallelization using the {\sc mpi} switch cannot be used
simultaneously.
\begin{slist}
\sit{omp0}{High level parallelization of calls to source term and
           propagation subroutines.}
\sit{omp1}{Parallelization of loops in output and other processing.}
\end{slist}

\noindent
Furthermore the following miscellaneous switches are available:
\begin{slist}
\sit{c90} {Compiler directives for Cray C90 (vectorization).}
\sit{cou} {Activates the calculation of variables required for coupling}
\sit{dss0}{Switch off frequency dispersion in diffusive
           dispersion correction.}
\sit{mgg }{Activate GSE alleviation correction in
           Eq.~(\ref{eq:move_GSE_avg2}).}
\sit{mgp }{Activate propagation correction in
           Eq.~(\ref{eq:bal_move}).} 
\sit{mgw }{Apply wind correction in moving grid approach of
           appendix~\ref{app:move}.}
\sit{mlim}{Use Miche-style shallow water limiter of Eq.~(\ref{eq:MLIM})}.
\sit{mpit}{Test output for \mpi\ initializations.}
\sit{mprf}{Profiling of individual models and nesting in {\file ww3\_multi}.}
\sit{nec} {Compiler directives for NEC SX6/SX8 (vectorization).}
\sit{nc4} {Activates the NetCDF-4 API in the NetCDF pre- and post-processing programs.}
\sit{nco} {Code modifications for operational implementation at NCO
           (NCEP Central Operations). Mostly changes unit numbers
           and file names. Not recommended for general use.} 
\sit{nnt} {Generate file test\_data\_{\it{nnn}}.ww3 with spectra and 
           nonlinear interactions for training and testing of NNIA}.
\sit{ref1} {Enables reflection of shorelines and icebergs}
\sit{rwnd}{Correct wind speed for current velocity.}
\sit{s}   {Enable subroutine tracing in the main \ws\
           subroutines by activating calls to the
           subroutine {\F strace}.}
\sit{sec1}   {Enable the use of global time steps less than 1~s, but does not allow output at time steps less than 1~s.}
\sit{t}   {Enable test output throughout the program(s).}
\sitn{t}  {Id.}
\sit{tdyn}{Dynamic increment of swell age in diffusive
           dispersion correction (test cases only).}
\sit{xw0 }{Swell diffusion only in \uq\ scheme.}
\sit{xw1 }{Id. wave growth diffusion only.}
\end{slist}


% -------------------------------------------------------------
\vsssub
\subsubsection{~Default model settings} \label{sub:opt_default}
\vsssub
%
% Note by F.A.: I guess the ``default'' is what is used as NCEP...
% I guess this may thus evolve ?
%
The default \ws\ is defined by the following selection of mandatory and
optional switches. Mandatory switch groups for which no option is listed here
do not influence model results, and their setting is therefore irrelevant with
respect to the definition of a default version of \ws. The default model is
defined by using the following switches :

\begin{slist}
\sit{llg}  {Longitude-latitude grid.}
\sit{pr3}  {Propagation scheme (UQ with averaging).}
\sit{ln1}  {Linear input term activated.}
\sit{st2}  {Basic source terms \citep{tol:JPO96}.}
\sit{stab2}{Switching on retuning and stability correction in basic
            source terms.}
\sit{nl1}  {Nonlinear interactions (DIA).}
\sit{bt1}  {Bottom friction (JONSWAP).}
\sit{db1}  {Depth-induced breaking (Battjes-Janssen).}
\sit{mlim} {Miche-style limiter activated.}
\sit{tr0}  {No triad interactions.}
\sit{bs0}  {No bottom scattering.}
\sit{xx0}  {No additional source term.}
\sit{wnt1} {Wind interpolation (linear).}
\sit{wnx1} {Wind interpolation (linear).}
\sit{rwnd} {Define wind as relative to current.}
\sit{crt1} {Current interpolation (linear).}
\sit{crx1} {Current interpolation (linear).}
\end{slist}

\noindent
The optional switches {\sc o8}, {\sc o9}, {\sc dss0}, {\sc mgp}, {\sc mgw},
{\sc ref1}, {\sc tdyn}, {\sc xw0} and {\sc xw1} modify model behavior and are {\it not}
used in the default version of \ws. All optional switches not explicitly
mentioned in this section do not influence model behavior and their setting is
therefore irrelevant for the definition of the default model.

Default parameter settings for all model options have been presented in
chapter~\ref{chapt:eq}. The model will automatically default to these values,
unless they are explicitly overwritten using {\F namelist} input provided by
the user in the input file for the grid preprocessor ({\file
ww3\_grid.inp}). The only parameter setting for which no default setting is
given is the swell age $T_s$ in the propagation option {\sc pr2}. The value of
this parameter is set to 0, and needs to be overwritten by the user to turn
the corresponding GSE alleviation method on.


% -------------------------------------------------------------
\vssub
\subsection{~Modifying the source code} \label{sec:mod}
\vssub

Source code can obviously be modified by editing the source code files in the
{\dir ftn} directory. However, it is usually more convenient to modify source
code files from the work directory {\dir work}. This can be done by generating
a link between the {\dir ftn} and {\dir work} directories. Such a link can be
generated by typing \command{ln3 filename} where {\code filename} is the name
of a source code or include file, with or without its proper
extension. Working from the work directory is recommended for several
reasons. First, the program can be tested from the same directory, because of
similar links to the input files. Secondly, links to the relevant switch,
compile and link programs are also available in this directory. Third, it
makes it easy to keep track of files which have been changed (i.e., only those
files to which links have been created might have been changed), and finally,
source codes will not disappear if files (links) are accidentally removed from
the work directory.

Modifying source codes is straightforward. Adding new switches to existing
subroutines, or adding new modules requires modification of the automated
compilation scripts. If a new subroutine is added to an existing module, no
modifications are necessary. If a new module is added to \ws, the following
steps are required to include it in the automatic compilation:

\begin{list}{\arabic{outpars})\hfill}
            {\usecounter{outpars} \leftmargin 15mm \labelwidth 7mm
             \rightmargin 5mm \itemsep 0mm \parsep 0mm}
\item Add the file name to sections 2.b and c of {\file make\_makefile.sh} to
      assure that the file is included in the makefile under the correct
      conditions.
\item Modify section 3.b of this script accordingly to assure that the proper
      module dependency is checked. Note that the dependency with the object
      code is checked, allowing for multiple or inconsistent module names in
      the file.
\item Run script interactively to assure that makefile is updated.
\end{list}

\noindent
For details of inclusion, see the actual scripts. Adding a new switch to the
compilation systems requires the following actions:

\begin{list}{\arabic{outpars})\hfill}
            {\usecounter{outpars} \leftmargin 15mm \labelwidth 7mm
             \rightmargin 5mm \itemsep 0mm \parsep 0mm}
\item Put switch in required source code files.
\item If the switch is part of a new group of switches, add a new
      'keyword' to {\file w3\_new}.
\item Update files to be touched in {\file w3\_new} if necessary.
\item Update {\file make\_makefile.sh} with the switch and/or keyword.
\end{list}

\noindent
These modifications need only be made if the switch selects program parts. For
test output etc., it is sufficient to simply add the switch to the source
code. Finally, adding an old switch to an additional subroutine requires these
actions:

\begin{list}{\arabic{outpars})\hfill}
            {\usecounter{outpars} \leftmargin 15mm \labelwidth 7mm
             \rightmargin 5mm \itemsep 0mm \parsep 0mm}
\item Update files to be touched in {\file w3\_new}.
\end{list}

If \ws\ is modified, it is convenient to maintain copies of previous versions
of the code and of the compilation scripts. To simplify this, an archive
script ({\file arc\_wwatch3}) is provided. This script generates {\file tar}
files that can be reinstalled by the install program {\file
install\_wwatch3}. The archive files are gathered in the directory {\dir
arc}. The names of the archive files can contain user defined identifiers (if
no identifier is used, the name will be identical to the original \ws\
files). The archive program is invoked by typing \command{arc\_wwatch3}
\noindent
The interactive input to this script is self-explanatory. An archive file can
be re-installed by copying the corresponding {\file tar} files to the \ws\
home directory, renaming them to the file names expected by the install
program, and running the install program.


% -------------------------------------------------------------
\vssub
\subsection{~Running test cases} \label{sec:tests}
\vssub

If \ws\ is installed and compiled successfully, it can be tested by running
the different program elements interactively from the {\file work}
directory. The switch settings in the generic switch file correspond to the
activated inputs in the example input files. It should therefore be possible
to run all model elements by typing
\command{ww3\_grid | more \\ 
         ww3\_strt | more \\
         ww3\_bound | more \\
         ww3\_prep | more \\
         ww3\_shel | more \\
         ww3\_outf | more \\
         ww3\_outp | more \\
         ww3\_ounf | more \\
         ww3\_ounp | more \\
         ww3\_trck | more \\
         ww3\_grib | more \\
         gx\_outf | more \\
         gx\_outp | more }
where the {\code more} command is added to allow for on-screen inspection of
the output. This {\code | more} can be replaced by redirection to an output 
file, e.g. \command{ww3\_grid > ww3\_grid.out }. Note that {\code ww3\_grib} will only provide GRIB output if a
user-supplied packing routine is linked in. Note furthermore that no simple
interactive test case for {\file ww3\_multi} is provided. GrADS can then be
run from the work directory to generate graphical output for these
calculations. All intermediate output files are placed in the {\file work}
directory, and can be removed conveniently by typing \command{w3\_clean}

Also available are several test cases in the directory {\dir test}. Example
output files for selected runs are identified with the extension `{\file
.tar}'. The documentation of each script identifies the preprocessor switches
required to run the test case, and example outputs if available. The test
cases are using the scratch directory as defined during the installation of
\ws, and relevant output files will be saved in the directory {\dir test}
(this can easily be changed in the top of each test script). Hence, running a
test case consists of five steps :

\begin{list}{\arabic{outpars})\hfill}
            {\usecounter{outpars} \leftmargin 15mm \labelwidth 7mm
             \rightmargin 5mm \itemsep 0mm \parsep 0mm}
\item Look up the required switches in the documentation of the
      test cases, and set these switches in {\file switch}. Do not
      add optional switches like {\F seed} unless specified
      explicitly.
\item Compile all programs by executing {\file w3\_make}.
\item Execute the test script from the test directory {\dir test}.
\item Check the output files in the test directory.
\item Clean up by executing {\file w3\_clean}.
\end{list}

\noindent
Note that most test cases expect that the code is compiled for a single
processor using the shared memory model. The \omp\ and \mpi\ versions of the
model can also be tested with the standard test cases, and should give
identical results. Converting a test case to run in parallel mode requires two
modifications to the above list

\begin{list}{\arabic{outpars})\hfill}
            {\usecounter{outpars} \leftmargin 15mm \labelwidth 7mm
             \rightmargin 5mm \itemsep 0mm \parsep 0mm}
\item Only the main program {\file ww3\_shel} or {\file ww3\_multi} should be
      compiled with the parallel options (see appendix~\ref{app:mpi}).
\item Modify the test script so that only {\file ww3\_shel} runs in the
      proper parallel environment. Because this environment is system
      dependent, this option has not been build into the script.
\end{list}


\bpage
